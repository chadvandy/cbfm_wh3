tower_of_zharr = {

	usurp_counter_base_time = 5,
	usurp_cost_multiplier = 50,
	usurp_cost_bundle_suffix = "_usurp_cost_modifier_hidden",
	confederation_cost_mod_effect = "wh3_dlc23_effect_toz_chd_conclave_influence_spent_slot_claimed_mod",
	districts_to_unlock_tier = 2,


	banners_and_followers_counter_reset = 3,
	banners_and_followers_list = {
		"wh3_dlc23_anc_banner_chd_banner_of_the_khanate",
		"wh3_dlc23_anc_banner_chd_eye_of_hashut",
		"wh3_dlc23_anc_banner_chd_hellbound_standard",
		"wh3_dlc23_anc_banner_chd_hobgoblin_standard",
		"wh3_dlc23_anc_banner_chd_oath_of_contempt",
		"wh3_dlc23_anc_banner_chd_standard_of_zharr",
		"wh3_dlc23_anc_follower_chd_arms_merchant",
		"wh3_dlc23_anc_follower_chd_artificer",
		"wh3_dlc23_anc_follower_chd_castellan_drillmaster",
		"wh3_dlc23_anc_follower_chd_convoy_enforcer",
		"wh3_dlc23_anc_follower_chd_dark_prophet",
		"wh3_dlc23_anc_follower_chd_devoted_of_hashut",
		"wh3_dlc23_anc_follower_chd_hobgoblin_scout",
		"wh3_dlc23_anc_follower_chd_infernal_deathmask",
		"wh3_dlc23_anc_follower_chd_infernal_engineer",
		"wh3_dlc23_anc_follower_chd_infernal_musician",
		"wh3_dlc23_anc_follower_chd_k'daai_hellsmith",
		"wh3_dlc23_anc_follower_chd_khanate_assassin",
		"wh3_dlc23_anc_follower_chd_khanate_raider",
		"wh3_dlc23_anc_follower_chd_khanate_scout",
		"wh3_dlc23_anc_follower_chd_navigator",
		"wh3_dlc23_anc_follower_chd_sorcerer_priest",
		"wh3_dlc23_anc_follower_chd_taur'ruk_guardian",
		"wh3_dlc23_anc_follower_chd_train_operator",
		"wh3_dlc23_anc_follower_chd_veteran_overseer",
		"wh3_dlc23_anc_follower_chd_warsmith",
	},
	enchanted_items_and_talismans_counter_reset = 3,
	enchanted_items_and_talismans_list = {
		"wh3_dlc23_anc_enchanted_item_daemon_flask_of_ashak",
		"wh3_dlc23_anc_enchanted_item_furnace_blast_gem",
		"wh3_dlc23_anc_enchanted_item_gauntlets_of_bazherak_the_cruel",
		"wh3_dlc23_anc_enchanted_item_naptha_bomb",
		"wh3_dlc23_anc_enchanted_item_the_mask_of_the_furnace",
		"wh3_dlc23_anc_enchanted_item_the_vial_of_hashut",
		"wh_main_anc_enchanted_item_healing_potion",
		"wh_main_anc_enchanted_item_potion_of_strength",
		"wh_main_anc_enchanted_item_potion_of_toughness",
		"wh_main_anc_enchanted_item_ruby_ring_of_ruin",
		"wh3_dlc23_anc_talisman_black_gem_of_gnar",
		"wh3_dlc23_anc_talisman_malignant_totem",
		"wh3_dlc23_anc_talisman_possessed_amulet",
		"wh3_dlc23_anc_talisman_talisman_of_obsidian",
		"wh_main_anc_talisman_obsidian_lodestone",
		"wh_main_anc_talisman_talisman_of_preservation",
		"wh_main_anc_arcane_item_forbidden_rod",
		"wh_main_anc_arcane_item_power_stone",
		"wh_main_anc_arcane_item_book_of_ashur",
		"wh_main_anc_arcane_item_scroll_of_leeching",
	},
	weapons_and_armours_counter_reset = 3,
	weapons_and_armours_list = {
		"wh3_dlc23_anc_weapon_dark_mace",
		"wh3_dlc23_anc_weapon_life_bane_blade",
		"wh_main_anc_weapon_giant_blade",
		"wh_main_anc_weapon_obsidian_blade",
		"wh_main_anc_weapon_ogre_blade",
		"wh2_main_anc_weapon_executioners_axe",
		"wh_main_anc_weapon_sword_of_bloodshed",
		"wh_main_anc_weapon_sword_of_strife",
		"wh3_dlc23_anc_armour_armour_of_bazherak_the_cruel",
		"wh3_dlc23_anc_armour_armour_of_the_forge",
		"wh3_dlc23_anc_armour_blackshard_armour",
		"wh_main_anc_armour_armour_of_destiny",
		"wh_main_anc_armour_armour_of_fortune",
		"wh_main_anc_armour_glittering_scales",
		"wh_main_anc_armour_helm_of_discord",
		"wh_main_anc_armour_tricksters_helm",
	},
	unit_cap_monsters_hidden_effect_bundle = "wh3_dlc23_bundle_chd_unit_cap_monsters_rituals_cost_mods_toz",
	unit_cap_monsters_unlock_counter_reset = 4,
	unit_cap_monsters_ritual_list = {
		"wh3_dlc23_chd_ritual_unit_cap_bale_taurus",
		"wh3_dlc23_chd_ritual_unit_cap_bull_centaurs",
		"wh3_dlc23_chd_ritual_unit_cap_great_taurus",
		"wh3_dlc23_chd_ritual_unit_cap_kdaai_destroyer",
		"wh3_dlc23_chd_ritual_unit_cap_kdaai_fireborn",
		"wh3_dlc23_chd_ritual_unit_cap_lammasu",
	},
	unit_cap_infantry_hidden_effect_bundle = "wh3_dlc23_bundle_chd_unit_cap_infantry_rituals_cost_mods_toz",
	unit_cap_infantry_unlock_counter_reset = 4,
	unit_cap_infantry_ritual_list = {
		"wh3_dlc23_chd_ritual_unit_cap_infernal_ironsworn",
		"wh3_dlc23_chd_ritual_unit_cap_infernal_guard_fireglaives",
		"wh3_dlc23_chd_ritual_unit_cap_infernal_guard",
		"wh3_dlc23_chd_ritual_unit_cap_chaos_dwarf_warriors",
		"wh3_dlc23_chd_ritual_unit_cap_chaos_dwarf_blunderbusses",
	},
}

tower_of_zharr.variables = {
	banners_and_followers_counter_current = 0,
	enchanted_items_and_talismans_counter_current = 0,
	weapons_and_armours_counter_current = 0,
	unit_cap_monsters_unlock_counter_current = 0,
	unit_cap_infantry_unlock_counter_current = 0,
	toz_current_tier = 1,
}

tower_of_zharr.confederation_seat_mapping = {
	wh3_dlc23_ritual_chd_toz_slot_t4_astragoth 	= "wh3_dlc23_chd_astragoth",
	wh3_dlc23_ritual_chd_toz_slot_t4_conclave 	= "wh3_dlc23_chd_conclave",
	wh3_dlc23_ritual_chd_toz_slot_t4_drazhoath 	= "wh3_dlc23_chd_legion_of_azgorh",
	wh3_dlc23_ritual_chd_toz_slot_t4_zhatan 	= "wh3_dlc23_chd_zhatan",
}

tower_of_zharr.is_scripted = {
	--TIER ONE
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_1 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_2 	=	true,
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_3 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_4 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_military_1 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_military_2 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_military_3 	=	true,
	wh3_dlc23_ritual_chd_toz_slot_t1_military_4 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_1 		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_2 		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_3 		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_4 		=	true,
--TIER TWO
	wh3_dlc23_ritual_chd_toz_slot_t2_industry_1 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t2_industry_2 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t2_industry_3 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t2_military_1 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t2_military_2 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t2_military_3 	=	true,
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_1 		=	true,
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_2 		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_3 		=	false,
--TIER THREE
	wh3_dlc23_ritual_chd_toz_slot_t3_industry_1 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t3_industry_2 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t3_military_1 	=	true,
	wh3_dlc23_ritual_chd_toz_slot_t3_military_2 	=	false,
	wh3_dlc23_ritual_chd_toz_slot_t3_sorcery_1 		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t3_sorcery_2 		=	false,
--TIER FOUR
	wh3_dlc23_ritual_chd_toz_slot_t4_astragoth		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t4_conclave		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t4_drazhoath		=	false,
	wh3_dlc23_ritual_chd_toz_slot_t4_zhatan			=	false,
}

tower_of_zharr.seats = 	{
--TIER ONE
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_1 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_2 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_3 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_4 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_military_1 	=	 {district_group_key = "DISTRICTS_MILITARY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_military_2 	=	 {district_group_key = "DISTRICTS_MILITARY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_military_3 	=	 {district_group_key = "DISTRICTS_MILITARY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_military_4 	=	 {district_group_key = "DISTRICTS_MILITARY_T1", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_1 		=	 {district_group_key = "DISTRICTS_SORCERY_T1", 	current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_2 		=	 {district_group_key = "DISTRICTS_SORCERY_T1",	current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_3 		=	 {district_group_key = "DISTRICTS_SORCERY_T1", 	current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_4 		=	 {district_group_key = "DISTRICTS_SORCERY_T1", 	current_owner = nil,	usurp_counter = 0},
--TIER TWO
	wh3_dlc23_ritual_chd_toz_slot_t2_industry_1 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T2", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_industry_2 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T2", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_industry_3 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T2", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_military_1 	=	 {district_group_key = "DISTRICTS_MILITARY_T2", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_military_2 	=	 {district_group_key = "DISTRICTS_MILITARY_T2", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_military_3 	=	 {district_group_key = "DISTRICTS_MILITARY_T2", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_1 		=	 {district_group_key = "DISTRICTS_SORCERY_T2", 	current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_2 		=	 {district_group_key = "DISTRICTS_SORCERY_T2", 	current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_3 		=	 {district_group_key = "DISTRICTS_SORCERY_T2", 	current_owner = nil,	usurp_counter = 0},
--TIER THREE
	wh3_dlc23_ritual_chd_toz_slot_t3_industry_1 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T3", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t3_industry_2 	=	 {district_group_key = "DISTRICTS_INDUSTRY_T3", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t3_military_1 	=	 {district_group_key = "DISTRICTS_MILITARY_T3", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t3_military_2 	=	 {district_group_key = "DISTRICTS_MILITARY_T3", current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t3_sorcery_1 		=	 {district_group_key = "DISTRICTS_SORCERY_T3", 	current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t3_sorcery_2 		=	 {district_group_key = "DISTRICTS_SORCERY_T3", 	current_owner = nil,	usurp_counter = 0},
--TIER FOUR
	wh3_dlc23_ritual_chd_toz_slot_t4_astragoth		=	 {district_group_key = "TOZ_TIER_4", 			current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t4_conclave		=	 {district_group_key = "TOZ_TIER_4", 			current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t4_drazhoath		=	 {district_group_key = "TOZ_TIER_4", 			current_owner = nil,	usurp_counter = 0},
	wh3_dlc23_ritual_chd_toz_slot_t4_zhatan			=	 {district_group_key = "TOZ_TIER_4", 			current_owner = nil,	usurp_counter = 0},
}

tower_of_zharr.districts = {
--Breaks scripting format conventions of lowercase_lowercase because these are the actual keys used in the db with the capitals formatting
--TIER ONE
	DISTRICTS_INDUSTRY_T1 		=	{district_type = "INDUSTRY",	effect_bundle_key = "wh3_dlc23_chd_toz_districts_industry_t1_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_1"},
	DISTRICTS_MILITARY_T1 		=	{district_type = "MILITARY",	effect_bundle_key = "wh3_dlc23_chd_toz_districts_military_t1_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_1"},	
	DISTRICTS_SORCERY_T1 		=	{district_type = "SORCERY",		effect_bundle_key = "wh3_dlc23_chd_toz_districts_sorcery_t1_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_1"},
--TIER TWO
	DISTRICTS_INDUSTRY_T2 		=	{district_type = "INDUSTRY",	effect_bundle_key = "wh3_dlc23_chd_toz_districts_industry_t2_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_2"},
	DISTRICTS_MILITARY_T2 		=	{district_type = "MILITARY",	effect_bundle_key = "wh3_dlc23_chd_toz_districts_military_t2_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_2"},
	DISTRICTS_SORCERY_T2 		=	{district_type = "SORCERY",		effect_bundle_key = "wh3_dlc23_chd_toz_districts_sorcery_t2_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_2"},
--TIER THREE
	DISTRICTS_INDUSTRY_T3 		=	{district_type = "INDUSTRY",	effect_bundle_key = "wh3_dlc23_chd_toz_districts_industry_t3_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_3"},
	DISTRICTS_MILITARY_T3 		=	{district_type = "MILITARY",	effect_bundle_key = "wh3_dlc23_chd_toz_districts_military_t3_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_3"},
	DISTRICTS_SORCERY_T3 		=	{district_type = "SORCERY",		effect_bundle_key = "wh3_dlc23_chd_toz_districts_sorcery_t3_reward", 	complete_status = false,	complete_counter = 0,	tier =	"toz_tier_3"},
--TIER FOUR
	TOZ_TIER_4 					=	{district_type = "OTHER",		effect_bundle_key = "blank", 											complete_status = false,	complete_counter = 0,	tier =	"toz_tier_4"},
}

tower_of_zharr.tiers = {
	toz_tier_1					=	{next_tier = "toz_tier_2", 	effect_bundle_key = "wh3_dlc23_chd_toz_tier_1_reward", 	locked_status = false, 	completed_district_counter = 0,	total_seats = 4},
	toz_tier_2					=	{next_tier = "toz_tier_3", 	effect_bundle_key = "wh3_dlc23_chd_toz_tier_2_reward", 	locked_status = true, 	completed_district_counter = 0,	total_seats = 3},
	toz_tier_3					=	{next_tier = "toz_tier_4", 	effect_bundle_key = "wh3_dlc23_chd_toz_tier_3_reward", 	locked_status = true, 	completed_district_counter = 0,	total_seats = 2},
	toz_tier_4					=	{next_tier = nil, 			effect_bundle_key = "wh3_dlc23_chd_toz_tier_4_reward", 	locked_status = true, 	completed_district_counter = 0,	total_seats = -1},
}


tower_of_zharr.factions = {
	"wh3_dlc23_chd_astragoth",
	"wh3_dlc23_chd_legion_of_azgorh",
	"wh3_dlc23_chd_zhatan",
}

tower_of_zharr.factories = {
	"wh3_dlc23_chd_settlement_factory_1",
	"wh3_dlc23_chd_settlement_factory_2",
	"wh3_dlc23_chd_settlement_factory_3",
}

tower_of_zharr.district_specialties = {
	SORCERY		=	{current_owner = nil, 	specialty_seat_counter = 0, effect_bundle_key = "wh3_dlc23_chd_toz_district_specialty_sorcery_"},
	INDUSTRY	=	{current_owner = nil, 	specialty_seat_counter = 0, effect_bundle_key = "wh3_dlc23_chd_toz_district_specialty_industry_"},
	MILITARY	=	{current_owner = nil, 	specialty_seat_counter = 0, effect_bundle_key = "wh3_dlc23_chd_toz_district_specialty_military_"},
}

tower_of_zharr.scripted_rituals = {
	wh3_dlc23_ritual_chd_toz_slot_t1_industry_2 = {
		event_name = "FactionTurnStart",
		condition_check = 
			function(context, faction_name)
				return context:faction():name() == faction_name
			end,
		seat_function = 
			function(context, faction_name)
				local counter_variables = tower_of_zharr.variables
				local faction = context:faction():name()

				if counter_variables.banners_and_followers_counter_current <= 0 then
					counter_variables.banners_and_followers_counter_current = tower_of_zharr.banners_and_followers_counter_reset
					local ancillary = tower_of_zharr.banners_and_followers_list[cm:random_number(#tower_of_zharr.banners_and_followers_list)]
					cm:add_ancillary_to_faction(cm:get_faction(faction_name), ancillary, false)
					cm:trigger_incident(faction, "wh3_dlc23_chd_toz_ancilliary_banners_followers", true)
				end
				counter_variables.banners_and_followers_counter_current = counter_variables.banners_and_followers_counter_current - 1
			end
	},
	wh3_dlc23_ritual_chd_toz_slot_t1_military_3 = {
		event_name = "FactionTurnStart",
		condition_check = 
			function(context, faction_name)
				return context:faction():name() == faction_name
			end,
		seat_function = 
			function(context, faction_name)
				local counter_variables = tower_of_zharr.variables
				local faction = context:faction():name()

				if counter_variables.weapons_and_armours_counter_current <= 0 then
					counter_variables.weapons_and_armours_counter_current = tower_of_zharr.weapons_and_armours_counter_reset
					local ancillary = tower_of_zharr.weapons_and_armours_list[cm:random_number(#tower_of_zharr.weapons_and_armours_list)]
					cm:add_ancillary_to_faction(cm:get_faction(faction_name), ancillary, false)
					cm:trigger_incident(faction, "wh3_dlc23_chd_toz_ancilliary_weapons_armour", true)
				end
				counter_variables.weapons_and_armours_counter_current = counter_variables.weapons_and_armours_counter_current - 1
			end
	},
	wh3_dlc23_ritual_chd_toz_slot_t3_military_1 = {
		event_name = "CharacterPerformsSettlementOccupationDecision",
		condition_check = 
			function(context, faction_name)
				local faction = context:character():faction()

				return context:occupation_decision() == hobgoblin_spawned_armies.occupation_option_id and faction:name() == faction_name and not faction:has_effect_bundle(hobgoblin_spawned_armies.spawned_army_blocked_bundle_key)
			end,
		seat_function = 
			function(context, faction_name)
				local region = context:garrison_residence():settlement_interface():region()
				local character = context:character()

				cm:apply_effect_bundle(hobgoblin_spawned_armies.spawned_army_blocked_bundle_key, faction_name, hobgoblin_spawned_armies.spawned_army_blocked_bundle_duration)
				hobgoblin_spawned_armies:spawn_army(region, character)
			end
	},
	wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_4 = {
		event_name = "FactionTurnStart",
		condition_check = 
			function(context, faction_name)
				return context:faction():name() == faction_name
			end,
		seat_function = 
			function(context, faction_name)
				local counter_variables = tower_of_zharr.variables
				local faction = context:faction():name()

				if counter_variables.enchanted_items_and_talismans_counter_current <= 0 then
					counter_variables.enchanted_items_and_talismans_counter_current = tower_of_zharr.enchanted_items_and_talismans_counter_reset
					local ancillary = tower_of_zharr.enchanted_items_and_talismans_list[cm:random_number(#tower_of_zharr.enchanted_items_and_talismans_list)]
					cm:add_ancillary_to_faction(cm:get_faction(faction_name), ancillary, false)
					cm:trigger_incident(faction, "wh3_dlc23_chd_toz_ancilliary_talismans_items", true)
				end
				counter_variables.enchanted_items_and_talismans_counter_current = counter_variables.enchanted_items_and_talismans_counter_current - 1
			end
	},
	wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_1 = {
		event_name = "FactionTurnStart",
		condition_check = 
			function(context, faction_name)
				return context:faction():name() == faction_name
			end,
		seat_function = 
			function(context, faction_name)
				local faction = context:faction():name()
				local hidden_effect = tower_of_zharr.unit_cap_monsters_hidden_effect_bundle
				local counter_variables = tower_of_zharr.variables
				if counter_variables.unit_cap_monsters_unlock_counter_current <= 0 then
					counter_variables.unit_cap_monsters_unlock_counter_current = tower_of_zharr.unit_cap_monsters_unlock_counter_reset
					local unit_cap_ritual = tower_of_zharr.unit_cap_monsters_ritual_list[cm:random_number(#tower_of_zharr.unit_cap_monsters_ritual_list)]
					cm:apply_effect_bundle(hidden_effect, faction, 0)
					cm:perform_ritual(faction, "", unit_cap_ritual)
					cm:trigger_incident(faction, "wh3_dlc23_chd_toz_cap_"..unit_cap_ritual, true)
				end
				cm:remove_effect_bundle(hidden_effect, faction)
				counter_variables.unit_cap_monsters_unlock_counter_current = counter_variables.unit_cap_monsters_unlock_counter_current - 1
			end
			
	},
	wh3_dlc23_ritual_chd_toz_slot_t2_military_3 = {
		event_name = "FactionTurnStart",
		condition_check = 
			function(context, faction_name)
				return context:faction():name() == faction_name
			end,
		seat_function = 
			function(context, faction_name)
				local faction = context:faction():name()
				local hidden_effect = tower_of_zharr.unit_cap_infantry_hidden_effect_bundle
				local counter_variables = tower_of_zharr.variables
				if counter_variables.unit_cap_infantry_unlock_counter_current <= 0 then
					counter_variables.unit_cap_infantry_unlock_counter_current = tower_of_zharr.unit_cap_infantry_unlock_counter_reset
					local unit_cap_ritual = tower_of_zharr.unit_cap_infantry_ritual_list[cm:random_number(#tower_of_zharr.unit_cap_infantry_ritual_list)]
					cm:apply_effect_bundle(hidden_effect, faction, 0)
					cm:perform_ritual(faction, "", unit_cap_ritual)
					cm:trigger_incident(faction, "wh3_dlc23_chd_toz_cap_"..unit_cap_ritual, true)
				end
				cm:remove_effect_bundle(hidden_effect, faction)
				counter_variables.unit_cap_infantry_unlock_counter_current = counter_variables.unit_cap_infantry_unlock_counter_current - 1
			end
			
	},
}

hobgoblin_spawned_armies = {
	occupation_option_id = "1671725074",
	spawned_army_general_subtype = "wh3_dlc23_chd_overseer_hobgoblin_spawned_army",
	spawned_army_size = 14,
	spawned_army_starting_bundle_key = "wh3_dlc23_bundle_force_chaos_dwarfs_summoned_army",
	spawned_army_immunity_bundle_key = "wh3_dlc23_bundle_force_chaos_dwarfs_summoned_army_duration",
	spawned_army_blocked_bundle_key = "wh3_dlc23_bundle_faction_chaos_dwarfs_summoned_army_blocked_dummy",
	spawned_army_initial_bundle_duration = 7,	-- needs to match dummy display in the db
	spawned_army_blocked_bundle_duration = 5 	-- needs to match dummy display in the db
}

function hobgoblin_spawned_armies:spawn_army(region, character)
	local region_key = region:name()
	local faction_key = character:faction():name()

	local x, y = cm:find_valid_spawn_location_for_character_from_settlement(faction_key, region_key, false, true, 10)
	
	if x > 0 then
		local ram = random_army_manager;
		ram:remove_force("chd_summoned_army");
		ram:new_force("chd_summoned_army");

		ram:add_mandatory_unit("chd_summoned_army","wh3_dlc23_chd_cav_hobgoblin_wolf_raiders_bows", 1)
		ram:add_mandatory_unit("chd_summoned_army","wh3_dlc23_chd_cav_hobgoblin_wolf_raiders_spears", 1)
		ram:add_mandatory_unit("chd_summoned_army","wh3_dlc23_chd_inf_hobgoblin_archers", 2)
		ram:add_mandatory_unit("chd_summoned_army","wh3_dlc23_chd_inf_hobgoblin_cutthroats", 2)
		ram:add_unit("chd_summoned_army","wh3_dlc23_chd_inf_hobgoblin_cutthroats",6)
		ram:add_unit("chd_summoned_army","wh3_dlc23_chd_inf_hobgoblin_sneaky_gits",4)
		ram:add_unit("chd_summoned_army","wh3_dlc23_chd_inf_hobgoblin_archers",4)
		ram:add_unit("chd_summoned_army","wh3_dlc23_chd_cav_hobgoblin_wolf_raiders_spears",2)
		ram:add_unit("chd_summoned_army","wh3_dlc23_chd_cav_hobgoblin_wolf_raiders_bows",2)

		local unit_list = ram:generate_force("chd_summoned_army", self.spawned_army_size, false)
		
		cm:create_force_with_general(
			faction_key,
			unit_list,
			region_key,
			x,
			y,
			"general",
			self.spawned_army_general_subtype,
			"",
			"",
			"",
			"",
			false,
			function(cqi)
				cm:apply_effect_bundle_to_characters_force(self.spawned_army_starting_bundle_key, cqi, 0);
				cm:apply_effect_bundle_to_characters_force(self.spawned_army_immunity_bundle_key, cqi, self.spawned_army_initial_bundle_duration);
			end
		)
	end
end



function tower_of_zharr:initialise()

	local seats = self.seats
	for ritual_key, seat in pairs(seats) do
		for index, owner in pairs(seat) do
			--Set UI States on Load for Seat ownership
			if index == "current_owner" and owner ~= nil then
				--set ui state to match seat ownership on load
				common.set_context_value(ritual_key.. "current_owner", owner)
				--set up listeners on load
				if self.is_scripted[ritual_key] then
					self:scripted_ritual_handler(seat, ritual_key, true)
				end
			end
		end
	end

	if cm:is_new_game() then
		local factions = self.factions
		for i = 1, #factions do
			local faction = cm:get_faction(factions[i])
			if faction:is_human() then
				-- lock the ToZ button
				local faction_name = faction:name()
				cm:override_ui("disable_toz_button", true)
			end
		end 
	end

	core:add_listener(
		"ToZ_PooledResourceChanged",
		"PooledResourceChanged",
		function(context)
			local pr = context:resource()
			return pr:key() == "wh3_dlc23_chd_conclave_influence" and pr:value() >= 75 and context:faction():is_human()
		end,
		function(context)
			local faction = context:faction():name()
			cm:override_ui("disable_toz_button", false)
			cm:trigger_incident(faction, "wh3_dlc23_chd_toz_feature_unlocked", true, true)
		end,
		false
	)

	core:add_listener(
		"ToZ_FactionTurnStart",
		"FactionTurnStart",
		function(context)
			local faction = context:faction()
			local pr = faction:pooled_resource_manager():resource("wh3_dlc23_chd_conclave_influence")
			if not pr:is_null_interface() then
				return pr:value() >= 75 and context:faction():is_human()
			end
			return false
		end,
		function(context)
			cm:override_ui("disable_toz_button", false)
		end,
		false
	)

	core:add_listener(
		"ToZ_RitualStartedEvent",
		"RitualStartedEvent",
		function(context)
			local ritual_category = context:ritual():ritual_category()
			local district = self.districts[ritual_category]

			return context:performing_faction() ~= nil and district ~= nil
		end,
		function(context)
			local ritual = context:ritual()
			local ritual_key = ritual:ritual_key()
			local ritual_category = ritual:ritual_category()

			local seat_key = ritual_key
			local seat = self.seats[ritual_key]
			
			local district = self.districts[ritual_category]
			local district_type = district.district_type

			local factions = self.factions

			local seat_usurped = false

			if seat.current_owner ~= nil then
				seat_usurped = true
				--pass the ritual key, the previous owner, and a bool for was usrped to UI
				common.set_context_value(ritual_key.. "usurped", seat.current_owner)
				if not cm:get_faction(seat.current_owner):is_dead() then
					--end ritual for previous owner
					cm:remove_effect_bundle(seat_key, seat.current_owner)
				end
				
				--increase usurp counter for seat
				seat.usurp_counter = seat.usurp_counter + 1
				
				if not cm:get_faction(seat.current_owner):is_dead() then
					local usurper_context = context:performing_faction()
					local usurper_faction = usurper_context:name()
					local usurpee_faction = cm:get_faction(seat.current_owner):name()
					local usurper_effect_bundle = "wh3_dlc23_faction_political_diplomacy_mod_toz_usurped_"..usurpee_faction
					local usurper_cqi = usurper_context:command_queue_index()
					local usurpee_cqi = cm:get_faction(seat.current_owner):command_queue_index()
					--apply diplomacy debuff to the usurper
					cm:apply_effect_bundle(usurper_effect_bundle, usurper_faction, 5)
					--trigger event for the usurper faction
					cm:trigger_incident_with_targets(usurper_cqi,"wh3_dlc23_chd_toz_diplomacy_usurping_"..seat.current_owner, usurpee_cqi, 0, 0, 0, 0, 0)
					--trigger event for usurpee faction
					cm:trigger_incident_with_targets(usurpee_cqi,"wh3_dlc23_chd_toz_diplomacy_usurped_by_"..usurper_faction, usurper_cqi, 0, 0, 0, 0, 0)
				end

			else 
				if seat.current_owner == nil then
					--inform other CHD that a seat was claimed
					for i = 1, #factions do
						local performing_faction_cqi = context:performing_faction():command_queue_index()
						local performing_faction_name = context:performing_faction():name()
						if factions[i] ~= performing_faction_name then
							local factions_cqi = cm:get_faction(factions[i]):command_queue_index()
							cm:trigger_incident_with_targets(factions_cqi,"wh3_dlc23_chd_toz_seat_claimed_"..performing_faction_name, performing_faction_cqi, 0, 0, 0, 0, 0)
						end
					end
				end
			end

			--set current owner to ritual performing faction
			seat.current_owner = context:performing_faction():name()
			common.set_context_value(ritual_key.. "current_owner", seat.current_owner)

			--apply usurp cost modifier to rituals that can be usurped (TIER 4 rituals cannot be usurped)
			if seat.district_group_key ~= "TOZ_TIER_4" then
				self:usurp_cost_modifier(seat, seat_key)
			else
			--scripted handler for granting occupied seats to new faction post confederation
				self:confederation_handler(seat.current_owner, seat_key)			
			end

			if ritual_key == "wh3_dlc23_ritual_chd_toz_slot_t3_sorcery_1" or ritual_key == "wh3_dlc23_ritual_chd_toz_slot_t3_military_2" or ritual_key == "wh3_dlc23_ritual_chd_toz_slot_t3_industry_2" then
				self:specialty_district_ownership(ritual_key, seat.current_owner)
			else 
				--check if the owner has specialty affinity with district type
				self:specialty_district_modifier(district_type, seat.current_owner, true)
			end

			--call function to handle the scripted ritual payloads
			if self.is_scripted[ritual_key] then
				self:scripted_ritual_handler(seat, seat_key, false)
			end
			
			--set ritual cooldown to cooldown duration
			local factions = self.factions
			for i = 1, #factions do
				if factions[i] ~= seat.current_owner then
					-- lock the ritual for usurp_counter_base_time turns for other factions
					cm:lock_ritual(cm:get_faction(factions[i]), seat_key, 5)
				end
			end

			if not seat_usurped then
				--check if this seat now creates a complete district
				self:district_complete_check(seat)
			end
			
			--unlock tower of zharr button for all if any participant claims a seat
			cm:override_ui("disable_toz_button", false)
		end,
		true
	)
	
	core:add_listener(
		"ToZ_ai_boost",
		"FactionTurnEnd",
		function(context)
			local faction = context:faction()
			return faction:culture() == "wh3_dlc23_chd_chaos_dwarfs" and not faction:is_human()
		end,
		function(context)
			local faction_name = context:faction():name()
			local turn = cm:model():turn_number()
			if turn >= 30 and turn % 15 == 0 then
				cm:faction_add_pooled_resource(faction_name, "wh3_dlc23_chd_conclave_influence", "wh3_dlc23_chd_conclave_influence_gained_events", 150)
			end
		end,
		true
	)
	self:update_shared_states()

end

function tower_of_zharr:district_complete_check(seat)

	local districts = self.districts
	local tiers = self.tiers

	local district = districts[seat.district_group_key]
	local tier = tiers[district.tier]

	 if district.complete_status == false then

		district.complete_counter = district.complete_counter +1
		
		if district.complete_counter == tier.total_seats then
			district.complete_status = true

			--apply district effect bundle to all chaos dwarf factions
			local model = cm:model()
			local faction_list = model:world():faction_list()

			for i = 0, faction_list:num_items() -1 do
				local current_faction = faction_list:item_at(i)
				if current_faction:culture() == "wh3_dlc23_chd_chaos_dwarfs" and not current_faction:is_dead() then
					cm:apply_effect_bundle(district.effect_bundle_key, current_faction:name(), -1)
				end
			end

			--check if this completed district unlocks a new tier
			self:tier_unlocked_check(seat, district)
		end
	end


end

function tower_of_zharr:tier_unlocked_check(seat, district)
	
	local seats = self.seats
	local districts = self.districts
	local tiers = self.tiers
	local factions = self.factions

	local tier = tiers[district.tier]
	tier.completed_district_counter = tier.completed_district_counter +1

	--check current tier is not the top tier
	if tier.next_tier ~= nil then
		local next_tier = tiers[tier.next_tier]

		--if district counter greater or equal to required districts then unlock next tier
		if tier.completed_district_counter == self.districts_to_unlock_tier then
			next_tier.locked_status = false
			self.variables.toz_current_tier = self.variables.toz_current_tier +1
			--unlocks next tier of rituals
			for k, v in pairs(districts) do
				for l, w in pairs(v) do
					if l == "tier" and w == tier.next_tier then
						for j = 1, #factions do
							cm:unlock_rituals_in_category(cm:get_faction(factions[j]), k, -1)
						end
					end
				end
			end
	
		--fire event when new ToZ tier is unlocked
			for i = 1, #factions do
				local faction = cm:get_faction(factions[i])
				local current_tier = self.variables.toz_current_tier
				if faction:is_human() then
					cm:trigger_incident(faction:name(), "wh3_dlc23_chd_toz_new_tier_unlocked_"..tostring(current_tier), true)
				end
			end
		end
	end
	self:update_shared_states()

end

function tower_of_zharr:specialty_district_ownership(ritual_key, faction_name)
	
	local seats = self.seats
	local seat = seats[ritual_key]
	local districts = self.districts

	local seat_district_type = seat.district_group_key
	local district_group = districts[seat_district_type]
	local district_key = district_group.district_type
	
	local specialty_seat = self.district_specialties[district_key]

	--check if there is a current owner, if there is remove any specialty bonus current owner has first
	if specialty_seat.current_owner ~= nil and specialty_seat.current_owner ~= faction_name then
		
		for k, s in pairs(seats) do
			for index, value in pairs(s) do
				--Set UI States on Load for Seat ownership
				if index == "current_owner" and value == specialty_seat.current_owner then

					local d_group = districts[s.district_group_key]
					local d_type = d_group.district_type
					if d_type == district_key then
						self:specialty_district_modifier(district_key, specialty_seat.current_owner, false)
					end

				end
			end
		end
		-- call it one more time to cover that the seat ownership will have already changed prior to this exchange happening which would leave the previous owner faction with a 1 remainder count
		self:specialty_district_modifier(district_key, specialty_seat.current_owner, false)
	end

	specialty_seat.current_owner = faction_name
		
	for k, s in pairs(seats) do
		for index, value in pairs(s) do
			--Set UI States on Load for Seat ownership
			if index == "current_owner" and value == specialty_seat.current_owner then
				
				local d_group = districts[s.district_group_key]
				local d_type = d_group.district_type
				if d_type == district_key then
					self:specialty_district_modifier(district_key, specialty_seat.current_owner, true)
				end
				
			end
		end
	end


end

function tower_of_zharr:specialty_district_modifier(district_key, faction_name, modifier_is_addition)
	
	local specialty_seat = self.district_specialties
	local specialty_district = specialty_seat[district_key]
	if specialty_district ~= nil then
        if specialty_district.current_owner ~= faction_name  and specialty_district.current_owner ~= nil then
			local previous_counter = specialty_district.specialty_seat_counter
            specialty_district.specialty_seat_counter = previous_counter - 1
			local new_counter = specialty_district.specialty_seat_counter
			local effect_bundle_prefix = specialty_district.effect_bundle_key
            local owner = specialty_district.current_owner
			if previous_counter > 0 then
				--remove previous effect_bundle 
				cm:remove_effect_bundle(effect_bundle_prefix .. tostring(previous_counter), owner)
			end
			if new_counter > 0 then
				--apply new effect_bundle 
				cm:apply_effect_bundle(effect_bundle_prefix .. tostring(new_counter), owner,  -1)
			end
		end
		if specialty_district.current_owner == faction_name then
			
			local previous_counter = specialty_district.specialty_seat_counter
			--check if the modification is addition or subtraction
			if modifier_is_addition then
				specialty_district.specialty_seat_counter  = previous_counter + 1
			else
				specialty_district.specialty_seat_counter  = previous_counter - 1
			end

			local new_counter = specialty_district.specialty_seat_counter

			local effect_bundle_prefix = specialty_district.effect_bundle_key

			if previous_counter > 0 then
				--remove previous effect_bundle 
				cm:remove_effect_bundle(effect_bundle_prefix .. tostring(previous_counter), faction_name)
			end
			if new_counter > 0 then
				--apply new effect_bundle 
				cm:apply_effect_bundle(effect_bundle_prefix .. tostring(new_counter), faction_name,  -1)
			end
		end
	end
end

function tower_of_zharr:usurp_cost_modifier(seat, seat_key)

	local cost_modifier = self.usurp_cost_multiplier * (1 + seat.usurp_counter)
	local usurp_effect = seat_key .. self.usurp_cost_bundle_suffix
	local usurp_effect_bundle = cm:create_new_custom_effect_bundle(usurp_effect)

	usurp_effect_bundle:add_effect(usurp_effect, "faction_to_faction_own_unseen", cost_modifier)
	usurp_effect_bundle:set_duration(0)

	local factions = self.factions
	for i = 1, #factions do
		local faction = cm:get_faction(factions[i])

		if faction:has_effect_bundle(usurp_effect_bundle:key()) then
			cm:remove_effect_bundle(usurp_effect_bundle:key(), faction:name())
		end;
		
		-- apply increased ritual cost to all playable chaos dwarf factions
		cm:apply_custom_effect_bundle_to_faction(usurp_effect_bundle, faction)

	end

end

function tower_of_zharr:confederation_handler(performing_faction, seat_key)
	
	local target_faction_name = self.confederation_seat_mapping[seat_key]
	local seats = self.seats
	
	cm:apply_effect_bundle(self.confederation_cost_mod_effect, performing_faction, 0)

	for k, v in pairs(seats) do
		for l, w in pairs(v) do
			if l == "current_owner" and w == target_faction_name then
				local ritual_key = k
				cm:unlock_ritual(cm:get_faction(performing_faction), ritual_key, 1)
				cm:perform_ritual(performing_faction, "", ritual_key)
			end
		end
	end
	cm:remove_effect_bundle(self.confederation_cost_mod_effect, performing_faction)

end

function tower_of_zharr:scripted_ritual_handler(seat, seat_key, game_load)
	
	local faction_name = seat.current_owner
	local scripted_ritual = self.scripted_rituals[seat_key]

	if not game_load then 
		local counter_variables = self.variables
		--if a ritual with a counter has been performed
		if seat_key == "wh3_dlc23_ritual_chd_toz_slot_t1_industry_2" then 
			counter_variables.banners_and_followers_counter_current = 0
		elseif seat_key == "wh3_dlc23_ritual_chd_toz_slot_t1_military_3" then 
			counter_variables.weapons_and_armours_counter_current = 0
		elseif seat_key == "wh3_dlc23_ritual_chd_toz_slot_t1_sorcery_4" then 
			counter_variables.enchanted_items_and_talismans_counter_current = 0
		elseif seat_key == "wh3_dlc23_ritual_chd_toz_slot_t2_sorcery_1" then 
			counter_variables.unit_cap_monsters_unlock_counter_current = 0
		elseif seat_key == "wh3_dlc23_ritual_chd_toz_slot_t2_military_3" then 
			counter_variables.unit_cap_infantry_unlock_counter_current = 0
		end
	end

	core:add_listener(
		seat_key .. "_listener",
		scripted_ritual.event_name,
		function(context)
			return scripted_ritual.condition_check(context, faction_name)
		end,
		function(context)
			scripted_ritual.seat_function(context, faction_name)
		end,
		true
	)
end

function tower_of_zharr:update_shared_states()
	local is_toz_tier_3_unlocked = false
	local is_toz_tier_2_unlocked = false
	if tower_of_zharr.tiers.toz_tier_3.locked_status == false then
		is_toz_tier_3_unlocked = true
	end
	if tower_of_zharr.tiers.toz_tier_2.locked_status == false then
		is_toz_tier_2_unlocked = true
	end
	cm:set_script_state("is_toz_tier_3_unlocked", is_toz_tier_3_unlocked)
	cm:set_script_state("is_toz_tier_2_unlocked", is_toz_tier_2_unlocked)
end

--------------------------------------------------------------
----------------------- SAVING / LOADING ---------------------
--------------------------------------------------------------

cm:add_saving_game_callback(
	function(context)
		cm:save_named_value("TowerOfZharrSeats", tower_of_zharr.seats, context)
		cm:save_named_value("TowerOfZharrDistricts", tower_of_zharr.districts, context)
		cm:save_named_value("TowerOfZharrTiers", tower_of_zharr.tiers, context)
		cm:save_named_value("TowerOfZharrFactionSpecialties", tower_of_zharr.district_specialties, context)
		cm:save_named_value("TowerOfZharrVariables", tower_of_zharr.variables, context)
	end
)
cm:add_loading_game_callback(
	function(context)
		if cm:is_new_game() == false then
			tower_of_zharr.seats 				= cm:load_named_value("TowerOfZharrSeats", tower_of_zharr.seats, context)
			tower_of_zharr.districts 			= cm:load_named_value("TowerOfZharrDistricts", tower_of_zharr.districts, context)
			tower_of_zharr.tiers 				= cm:load_named_value("TowerOfZharrTiers", tower_of_zharr.tiers, context)
			tower_of_zharr.district_specialties = cm:load_named_value("TowerOfZharrFactionSpecialties", tower_of_zharr.district_specialties, context)
			tower_of_zharr.variables 			= cm:load_named_value("TowerOfZharrVariables", tower_of_zharr.variables, context)
		end
	end
)
